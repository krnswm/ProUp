// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model - represents authenticated users
model User {
  id        Int             @id @default(autoincrement())
  email     String          @unique
  name      String
  password  String
  passwordResetToken     String?   @unique
  passwordResetExpiresAt DateTime?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  
  // Relations
  ownedProjects Project[]       @relation("ProjectOwner")
  memberships   ProjectMember[]
  invitations   Invitation[]
  documents     Document[]
  notifications Notification[]
  comments      Comment[]
  templates     ProjectTemplate[]
  reactions     TaskReaction[]
}

// Project model - represents a project that contains tasks
model Project {
  id          Int             @id @default(autoincrement())
  name        String
  description String?
  color       String          @default("#3b82f6") // Default blue color for calendar display
  status      String          @default("active") // "active" | "paused" | "completed"
  ownerId     Int             // Owner of the project
  owner       User            @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  // Relations
  tasks       Task[]
  members     ProjectMember[]
  invitations Invitation[]
  whiteboard  Whiteboard?
  documents   Document[]
  labels      Label[]
  
  @@index([ownerId])
}

model ProjectTemplate {
  id          Int                   @id @default(autoincrement())
  name        String
  description String?
  ownerId     Int
  owner       User                  @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  tasks       ProjectTemplateTask[]
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@index([ownerId])
  @@unique([ownerId, name])
}

model ProjectTemplateTask {
  id            Int             @id @default(autoincrement())
  templateId    Int
  template      ProjectTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  status        String          @default("todo")
  priority      String          @default("medium")
  dueOffsetDays Int?
  position      Int             @default(0)

  @@index([templateId])
}

// Whiteboard model - stores canvas state for real-time collaboration
model Whiteboard {
  id        Int      @id @default(autoincrement())
  projectId Int      @unique
  data      String   @default("{}") // JSON string of canvas state
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
}

// Document model - stores collaborative documents and spreadsheets
model Document {
  id        Int      @id @default(autoincrement())
  projectId Int
  name      String
  type      String   // "document" | "spreadsheet"
  content   String   @default("{}") // JSON string of document content
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator   User     @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  
  @@index([projectId])
  @@index([createdBy])
}

// ProjectMember model - many-to-many relationship with roles
model ProjectMember {
  id        Int      @id @default(autoincrement())
  projectId Int
  userId    Int
  role      String   @default("Viewer") // "Admin" | "Member" | "Viewer"
  joinedAt  DateTime @default(now())
  
  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

// Invitation model - handles pending team invites
model Invitation {
  id        Int      @id @default(autoincrement())
  email     String
  projectId Int
  role      String   @default("Viewer") // "Admin" | "Member" | "Viewer"
  token     String   @unique
  status    String   @default("pending") // "pending" | "accepted" | "expired"
  invitedBy Int
  createdAt DateTime @default(now())
  expiresAt DateTime
  
  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  inviter   User     @relation(fields: [invitedBy], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([email])
  @@index([projectId])
}

model Task {
  id           Int           @id @default(autoincrement())
  title        String
  description  String?
  assignedUser String
  dueDate      String?
  status       String        @default("todo") // "todo" | "inprogress" | "done"
  priority     String        @default("medium") // "low" | "medium" | "high"
  position     Int           @default(0)
  projectId    Int?          // Optional link to a project
  project      Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  activityLogs ActivityLog[]
  comments     Comment[]
  labels       TaskLabel[]
  attachments  TaskAttachment[]
  reactions    TaskReaction[]
  coverColor   String?       // custom card cover color/gradient

  // Dependencies
  blockedBy    TaskDependency[] @relation("BlockedTask")
  blocks       TaskDependency[] @relation("BlockingTask")
}

model TaskDependency {
  id              Int  @id @default(autoincrement())
  blockedTaskId   Int
  blockingTaskId  Int

  // Relations
  blockedTask     Task @relation("BlockedTask", fields: [blockedTaskId], references: [id], onDelete: Cascade)
  blockingTask    Task @relation("BlockingTask", fields: [blockingTaskId], references: [id], onDelete: Cascade)

  @@unique([blockedTaskId, blockingTaskId])
  @@index([blockedTaskId])
  @@index([blockingTaskId])
}

model Label {
  id        Int         @id @default(autoincrement())
  projectId Int
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name      String
  color     String      @default("#3b82f6") // hex color
  createdAt DateTime    @default(now())
  tasks     TaskLabel[]

  @@unique([projectId, name])
  @@index([projectId])
}

model TaskLabel {
  id      Int   @id @default(autoincrement())
  taskId  Int
  labelId Int
  task    Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  label   Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([taskId, labelId])
  @@index([taskId])
  @@index([labelId])
}

model TaskAttachment {
  id        Int      @id @default(autoincrement())
  taskId    Int
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  filename  String
  mimetype  String
  size      Int      // bytes
  data      Bytes    // file content stored as blob
  createdAt DateTime @default(now())

  @@index([taskId])
}

model TaskReaction {
  id        Int      @id @default(autoincrement())
  taskId    Int
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emoji     String   // e.g. "üëç", "üî•", "üéâ"
  createdAt DateTime @default(now())

  @@unique([taskId, userId, emoji])
  @@index([taskId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  taskId    Int
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId  Int
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  body      String
  createdAt DateTime @default(now())

  @@index([taskId])
  @@index([authorId])
  @@index([createdAt])
}

model ActivityLog {
  id         Int      @id @default(autoincrement())
  taskId     Int
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId     String   // User who made the change
  actionType String   // "UPDATED_PRIORITY", "UPDATED_STATUS", "UPDATED_ASSIGNEE", "UPDATED_DUE_DATE", "CREATED_TASK"
  fieldName  String   // "priority", "status", "assignedUser", "dueDate"
  oldValue   String?  // Previous value (null for creation)
  newValue   String   // New value
  timestamp  DateTime @default(now())

  @@index([taskId])
  @@index([timestamp])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  title     String
  body      String?
  link      String?
  readAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([readAt])
  @@index([createdAt])
}
